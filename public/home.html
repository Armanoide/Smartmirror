<html>
<head>
    <title>Enum</title>

    <link rel="stylesheet" href="css/style.css" type="text/css" />
    <link rel="stylesheet" href="css/font-awesome.min.css" type="text/css" />

    <script src="js/jquery-2.2.1.min.js" type="text/javascript"></script>
    <script src="js/socket.io-2.0.3.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="./css/flipclock.css">
    <script src="./js/flipclock.min.js"></script>
    <script src="./js/modernizr.2.6.2.min.js"></script>
    <script src="./js/polyfills.js"></script>
    <script src="./js/gesture.js"></script>
    <script src="js/state.js"></script>
    <script src="./js/menu-manager.js"></script>
</head>

<body>
<img id="img-debug" >
</img>
<div class="component">

    <div class="debug">
        <p id="debug_position_hand_vertical"></p>
        <p id="debug_position_hand_horizontal"></p>
        <p id="debug_count_circle_convex"></p>
    </div>

    <div id="wrapper-clock">
        <div class="clock"></div>
    </div>

    <p id="welcome-message">Hi !</p>
    <p id="unlock-message">pass your hand to unlock</p>

    <img id="no-connection" src="./img/icon_no_connection.png" width="128" height="128" />

    <div id="wrapper-hand">
        <img id="hand-red" src="./img/hand_mask_red.png" width="320" height="240" />
        <div class="circle" style="display: none"></div>
        <div class="circle1" style="display: none"></div>
    </div>


    <div id="weather">
        <div id="weather-panel">
            <p id="weather-temp">21</p>
            <p id="weather-phrase">Ensoleillé</p>
        </div>
    </div>

    <!-- Start Nav Structure -->
    <button class="cn-button" id="cn-button">Menu</button>
    <div class="cn-wrapper" id="cn-wrapper" position="-1">
        <ul>
            <li><a href="#" onclick="display_weather()"><span>Météo</span></a></li>
            <li><a href="#"><span>Actualité</span></a></li>
            <li><a href="#"><span>Articles</span></a></li>
            <li><a href="#"><span>Snippets</span></a></li>
            <li><a href="#"><span>Plugins</span></a></li>
            <li><a href="#"><span>Contact</span></a></li>
            <li><a href="#"><span>Follow</span></a></li>
        </ul>
    </div>
    <!-- End of Nav Structure -->
</div>


<script type="text/javascript">
    var clock;
    var animationMenuEnd = true;
    var socket;
    var gesture;
    var state;
    var menu;
    // like weather ...
    var appRunning = null;
    var isAvaiableForGesture = true
    display_status_off();
    $(document).ready(function() {
        clock = $('.clock').FlipClock({
            clockFace: 'TwentyFourHourClock'
        });

        //display_status_in_use();
        socket = io('http://localhost:3000', {transport:['websocket']});
        menu = new MenuManager();
        // if server connected and accept
        socket.on('connect', function(){

            gesture = new Gesture(socket);
            state = new State(socket);
            bind()

        });
        socket.on('disconnect', function(){ display_no_connection(); });
        // if server is disconnected displa it

        socket.on('hsv_img', function (data) {
            var b64 = "data:image/jpeg;base64," + data.hsv_img;
            $('#img-debug').attr('src', b64);
        });

        function bind() {

            gesture.on(function (type, value) {

                console.log(value);

                if (!appRunning && gesture.position_hand_vertical
                    && gesture.position_hand_vertical === "UP"
                    && animationMenuEnd === true) {
                    animationMenuEnd = false;
                    $("#cn-button").click();
                    setTimeout(function () {
                        animationMenuEnd = true;
                    }, 2000);
                }


                if (appRunning && gesture.position_hand_vertical
                    && gesture.position_hand_vertical === "UP") {
                    display_status_off();
                    display_status_in_use();
                    appRunning = null;
                }

                if (state.type === "IN_USE" && menu.isOpen === true && isAvaiableForGesture === true) {

                    isAvaiableForGesture = false;

                    setTimeout(function(){
                        isAvaiableForGesture = true;
                    }, 1000);


                    var lastPosition =   parseInt($("#cn-wrapper").attr("position"));

                    if (gesture.count_circle_convex >= 3) {
                        console.log("selection nb " + lastPosition);
                        $("#cn-wrapper li:nth-child("+lastPosition+") a").click();
                    }

                    if (gesture.count_circle_convex > 2) {
                        return
                    }

                    if (lastPosition === -1) {
                        lastPosition = 1;
                    }
                    console.log("lastPosition");
                    console.log(lastPosition);

                    if (gesture.position_hand_horizontal === "LEFT") {
                        lastPosition--;
                    }
                    if (gesture.position_hand_horizontal === "RIGHT") {
                        lastPosition++;
                    }
                    if (lastPosition <= 0) {
                        lastPosition = 1;
                    }
                    if (lastPosition > $("#cn-wrapper li").length) {
                        lastPosition = $("#cn-wrapper li").length
                    }
                    console.log("after eval lastPosition");
                    console.log(lastPosition);

                    $("#cn-wrapper li").each(function(){
                        $(this).removeClass('hover');
                    });

                    $("#cn-wrapper li:nth-child("+lastPosition+")").addClass('hover');
                    $("#cn-wrapper").attr('position', lastPosition);

                }


            });



            state.on(function (type) {
                if (type === "OFF") {
                    display_status_off();
                }
                if (type === "STANDBY"){
                    display_status_standby();
                }
                if (type === "RECORDING"){
                    display_status_recording();
                }
                if (type === "DETECTION") {
                    display_status_recording();
                }
                if (type === "IN_USE") {
                    display_status_in_use();
                }

            });
        }
    });



    function display_status_off() {
        $('#hand-red').hide();
        $('.circle1').hide();
        $('.circle').hide();
        $('#welcome-message').hide();
        $('#unlock-message').hide();
        $('#no-connection').hide();
        $('#cn-button').hide();
        $('#weather').hide();
    }

    function display_status_standby() {
        display_status_off();
        $('#hand-red').show();
        $('#welcome-message').show();
        $('#unlock-message').show();
        $('#no-connection').hide();
    }

    function display_status_recording() {
        display_status_off();
        $('.circle1').show();
        $('.circle').show();
        $('#welcome-message').show();
    }

    function display_status_in_use() {
        display_status_off();
        $('#cn-button').show();
    }

    function display_no_connection() {
        $('#no-connection').show();
        $('#hand-red').hide();
        $('.circle1').hide();
        $('.circle').hide();
        $('#welcome-message').hide();
        $('#unlock-message').hide();
        $('#cn-button').hide();
    }

    function display_weather() {
        appRunning = "weather";
        display_status_off();
        menu.close();
        $("#weather").show();
    }


</script>
</body>
</html>